"use client";

import { useState, useRef, useEffect } from "react";
import Submenu from "./Submenu";
import { submenuConfigs } from "./submenuData";
import UtilityBar from "./UtilityBar";
import MobileOverlayMenu from "./MobileOverlayMenu";
import SearchModal from "./SearchModal";

export default function SecondaryNav() {
    const [openKey, setOpenKey] = useState<string | null>(null);
    const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

    const [searchModalOpen, setSearchModalOpen] = useState(false);
    const [isScrolled, setIsScrolled] = useState(false);
    const closeTimerRef = useRef<number | null>(null);

    const scheduleClose = () => {
        if (closeTimerRef.current) window.clearTimeout(closeTimerRef.current);
        closeTimerRef.current = window.setTimeout(() => setOpenKey(null), 160);
    };
    const cancelClose = () => {
        if (closeTimerRef.current) {
            window.clearTimeout(closeTimerRef.current);
            closeTimerRef.current = null;
        }
    };

    // Scroll event listener
    useEffect(() => {
        const handleScroll = () => {
            const scrollTop = window.scrollY;
            setIsScrolled(scrollTop > 50);
        };

        window.addEventListener('scroll', handleScroll);
        return () => window.removeEventListener('scroll', handleScroll);
    }, []);



    return (
        <div className={`w-full z-50 transition-all duration-300 ${
            isScrolled ? 'fixed top-0 left-0 bg-white shadow-lg' : 'relative'
        }`}>
            {/* Top Utility Bar (Desktop only) - Hidden when scrolled */}
            {!isScrolled && (
                <div className="hidden lg:block">
                    <UtilityBar onSearchClick={() => setSearchModalOpen(true)} />
                                </div>
            )}

            {/* Main Navbar */}
            <div className={`w-full px-3 md:px-6 lg:px-10 flex items-center justify-between relative z-50 transition-all duration-300 ${
                isScrolled ? 'py-4' : 'py-2'
            }`}>
                {/* Logo and US Services */}
                <div className={`logo flex xl:flex-row flex-col items-center gap-1 xl:gap-2 transition-colors duration-300 ${
                    isScrolled ? 'text-gray-800' : 'text-white'
                }`}>
                    {isScrolled ? (
                        // Colored logo for scrolled state
                        <svg className="cursor-pointer" width="136" height="46" viewBox="0 0 136 46" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <g clipPath="url(#clip0_5_1177)">
                                <path d="M129.912 18.9767L118.51 21.6121L122.641 23.2928L136 20.2188L129.934 17.7383L129.912 18.9767Z" fill="#5675AC"/>
                                <path d="M122.641 23.2932L130.001 26.2971V26.9938L135.9 25.6411L136 20.2192L122.641 23.2932Z" fill="#A4B1D6"/>
                                <path d="M101.206 23.127V23.8604L115.525 29.6398L110.701 30.7529L95.2991 24.5202L101.206 23.127Z" fill="#004B8D"/>
                                <path d="M115.525 29.6396L116.615 30.0819L130.001 26.9932L129.908 31.7184L110.601 36.1745L110.701 30.7527L115.525 29.6396Z" fill="#00539B"/>
                                <path d="M110.701 30.7527L110.601 36.1745L95.2434 29.9603L95.299 24.52L110.701 30.7527Z" fill="#002B5C"/>
                                <path d="M114.602 7.31885L130.012 13.5552L110.705 18.0114L95.2953 11.775L114.602 7.31885Z" fill="#004B8D"/>
                                <path d="M130.012 13.5552L129.912 18.977L110.605 23.4331L110.705 18.015L130.012 13.5552Z" fill="#00539B"/>
                                <path d="M110.705 18.0113L110.605 23.4331L95.1952 17.1967L95.2953 11.7749L110.705 18.0113Z" fill="#002B5C"/>
                                <path d="M13.478 29.6769C13.478 32.1575 11.4609 32.9389 10.2077 32.9389C7.03007 32.9389 5.1502 31.6046 5.1502 28.4901C5.1502 27.8008 5.23177 27.1927 5.38379 26.6509H0.244718C0.0889883 27.2664 0 27.9372 0 28.667C0 33.2964 3.27032 35.9686 9.85174 35.9686C13.6115 35.9686 18.5837 34.509 18.5837 30.6315V26.6546H13.478V29.6843V29.6769Z" fill="#7D93C4"/>
                                <path d="M13.478 22.3898V24.6603H18.5837V19.3638C18.5837 13.1753 14.6459 11.0854 9.67372 11.0854C5.86576 11.0854 2.9551 12.1543 1.39039 12.9099L2.64364 16.0244C4.11937 15.3094 6.3589 14.5538 8.68743 14.5538C11.5091 14.5538 13.478 15.3978 13.478 18.516V19.8098C8.00148 20.3405 3.20353 21.4905 1.1123 24.6603H6.57767C7.98294 23.3223 10.3708 22.7658 13.478 22.3898Z" fill="#00539B"/>
                                <path d="M29.0843 0.581055H23.6227V24.6604H29.0843V0.581055Z" fill="#00539B"/>
                                <path d="M29.0843 26.6509H23.6227V35.5226H29.0843V26.6509Z" fill="#7D93C4"/>
                                <path d="M37.8496 7.38887C39.5515 7.38887 40.8493 6.1873 40.8493 4.72035C40.8493 3.25339 39.5515 2.00391 37.8496 2.00391C36.1477 2.00391 34.85 3.20548 34.85 4.72035C34.85 6.23521 36.1922 7.38887 37.8496 7.38887Z" fill="#00539B"/>
                                <path d="M40.3006 11.5317H34.8352V24.6606H40.3006V11.5317Z" fill="#00539B"/>
                                <path d="M40.3006 26.6509H34.8352V35.5226H40.3006V26.6509Z" fill="#7D93C4"/>
                                <path d="M50.0039 23.772C50.0039 17.7604 51.7503 14.2884 56.0032 14.2884C57.1675 14.2884 58.8212 15.0624 58.8212 17.4471V24.6603H64.1048V16.7984C64.1048 13.5549 60.4786 11.0854 56.2665 11.0854C48.4763 11.0854 44.5793 16.2456 44.5793 24.0374C44.5793 24.2475 44.5831 24.4539 44.5905 24.6603H50.0113C50.0002 24.3691 49.9965 24.0742 49.9965 23.772" fill="#00539B"/>
                                <path d="M58.8249 29.7581C58.8249 32.4303 56.9896 32.5814 55.7363 32.5814C52.4326 32.5814 50.6936 30.5837 50.1745 26.6509H44.7722C45.6139 32.3492 49.255 35.7438 54.3051 35.7438C56.3629 35.7438 57.8869 35.39 58.8249 34.8518V36.363C58.8249 39.5697 57.301 41.7517 53.2706 41.7517C51.0311 41.7517 48.8842 41.0809 47.4938 40.3253L45.9736 43.0488C47.72 44.9104 50.7641 45.5775 54.2124 45.5775C60.2117 45.5775 64.1086 42.2824 64.1086 35.8728V26.6436H58.8249V29.7507V29.7581Z" fill="#7D93C4"/>
                                <path d="M87.9093 26.6509H82.4476V35.5226H87.9093V26.6509Z" fill="#7D93C4"/>
                                <path d="M78.3282 11.0854C71.0534 11.0854 68.9771 14.5575 68.9771 18.4276V24.6603H74.4387V18.516C74.4387 16.5589 75.6438 14.5096 78.5136 14.5096C81.3835 14.5096 82.4476 16.5589 82.4476 18.516V24.6603H87.9093V18.4276C87.9093 14.5575 85.603 11.0854 78.3282 11.0854Z" fill="#00539B"/>
                                <path d="M74.4387 26.6509H68.9771V35.5226H74.4387V26.6509Z" fill="#7D93C4"/>
                                <path d="M101.257 19.6514L101.206 23.1271L106.767 21.8702L101.257 19.6514Z" fill="#5A719A"/>
                                <path d="M101.206 23.127L106.767 21.8701L110.605 23.4329L112.555 22.9869L116.704 24.6787L116.615 30.0821L101.206 23.8605V23.127Z" fill="#003161"/>
                                <path d="M112.555 22.9871L118.51 21.6123L122.641 23.293L116.715 24.6789L112.555 22.9871Z" fill="#005091"/>
                                <path d="M116.708 24.6752L116.623 30.0896L130.001 26.9936V26.2969L122.648 23.2856L116.708 24.6752Z" fill="#6A85BB"/>
                                <path d="M129.908 31.7148L129.812 37.1367L110.505 41.5928L110.605 36.1747L129.908 31.7148Z" fill="#7D93C4"/>
                                <path d="M110.605 36.1747L110.505 41.5929L95.1915 35.3896L95.2434 29.9604L110.605 36.1747Z" fill="#31517F"/>
                            </g>
                            <defs>
                                <clipPath id="clip0_5_1177">
                                    <rect width="136" height="45" fill="white" transform="translate(0 0.581055)"/>
                                </clipPath>
                            </defs>
                        </svg>
                    ) : (
                        // White logo for non-scrolled state
                        <svg className="cursor-pointer" width="136" height="45" viewBox="0 0 136 45" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M135.954 18.044C135.955 18.041 135.956 18.0376 135.955 18.0343C135.954 18.031 135.953 18.028 135.95 18.0257C135.948 18.0069 135.943 17.9884 135.936 17.9708C135.932 17.9513 135.924 17.9327 135.914 17.9158C135.9 17.8869 135.883 17.8598 135.862 17.8352C135.857 17.8209 135.848 17.8082 135.837 17.7986C135.816 17.7727 135.793 17.7493 135.767 17.729L135.763 17.7253C135.76 17.7216 135.756 17.7216 135.752 17.718C135.732 17.7 135.708 17.6851 135.683 17.674C135.656 17.6584 135.628 17.6449 135.599 17.6337L129.978 15.3219L130.047 11.5776V11.519C130.047 11.4881 130.044 11.4573 130.036 11.4274C130.034 11.4135 130.031 11.4 130.025 11.3871C130.012 11.3288 129.987 11.2739 129.952 11.2259C129.938 11.2036 129.922 11.1827 129.904 11.1636C129.885 11.141 129.865 11.1202 129.842 11.1013C129.838 11.0976 129.835 11.0976 129.831 11.094L129.827 11.0903L129.794 11.0683C129.784 11.0614 129.773 11.0553 129.761 11.05C129.734 11.0344 129.706 11.0209 129.677 11.0097L114.482 4.82166C114.376 4.77869 114.259 4.76973 114.148 4.79602L95.0649 9.22546C95.0612 9.22546 95.0576 9.22912 95.0539 9.22912C95.0362 9.23181 95.019 9.23673 95.0026 9.24378C94.9873 9.24831 94.9726 9.25445 94.9586 9.2621C94.9366 9.27309 94.922 9.28042 94.9037 9.29141C94.879 9.30641 94.8557 9.32357 94.834 9.3427C94.8148 9.35881 94.7965 9.37593 94.7791 9.39399C94.7649 9.40824 94.7526 9.42424 94.7424 9.44162C94.7351 9.45261 94.7314 9.45994 94.7241 9.47093C94.7092 9.4958 94.6958 9.52149 94.6838 9.54787L94.6801 9.55153V9.5552C94.6772 9.55949 94.6759 9.56469 94.6765 9.56985C94.6666 9.58799 94.6603 9.60791 94.6581 9.62847C94.651 9.64845 94.6472 9.66952 94.6472 9.69075V9.70541C94.6458 9.70686 94.6447 9.70859 94.6441 9.71049C94.6435 9.71239 94.6433 9.71441 94.6435 9.7164C94.6405 9.72712 94.6392 9.73826 94.6398 9.74937V9.76403L94.5409 15.135C94.5393 15.2459 94.5708 15.3546 94.6316 15.4474C94.6923 15.5401 94.7794 15.6125 94.8817 15.6553L110.011 39.9091C110.019 39.9133 110.028 39.9158 110.037 39.9165C110.063 39.9267 110.09 39.9341 110.118 39.9385C110.151 39.9455 110.186 39.9492 110.22 39.9494C110.275 39.9496 110.329 39.9422 110.381 39.9275L129.424 35.5054C129.544 35.4772 129.65 35.4101 129.727 35.3145C129.804 35.219 129.847 35.1005 129.849 34.9778L129.948 29.5921C129.949 29.5834 129.948 29.5747 129.945 29.5665L130.029 25.3275V25.3239L135.441 24.0782C135.56 24.0514 135.667 23.9851 135.745 23.8901C135.822 23.795 135.865 23.6767 135.866 23.5543L135.969 18.1649V18.1503C135.969 18.1143 135.965 18.0785 135.954 18.044ZM129.611 17.4249C129.719 17.3822 129.809 17.3048 129.868 17.2051C129.877 17.1928 129.885 17.1792 129.89 17.1647C129.894 17.1565 129.898 17.1479 129.901 17.1391C129.908 17.1279 129.913 17.1155 129.915 17.1025C129.922 17.0928 129.926 17.0813 129.926 17.0695C129.941 17.0246 129.949 16.9776 129.948 16.9303L129.956 16.5016L133.613 18.0037L116.453 21.9569L114.178 21.041L129.523 17.4542C129.554 17.4477 129.583 17.4379 129.611 17.4249ZM110.301 21.8983H110.345V21.8946H110.356C110.37 21.8952 110.385 21.894 110.4 21.891C110.415 21.8903 110.429 21.8878 110.444 21.8836L110.469 21.8763L110.506 21.8653C110.499 21.869 110.488 21.8726 110.48 21.8763L112.261 21.4623H112.265L115.823 22.8875L115.727 27.1484L115.72 27.4085C115.704 27.3188 115.665 27.2348 115.606 27.1648C115.548 27.0947 115.472 27.0411 115.387 27.0092L101.58 21.4V18.3848L105.658 20.0444L110.074 21.8397L110.081 21.8433H110.085C110.088 21.847 110.092 21.847 110.096 21.8507L110.103 21.8543C110.107 21.8543 110.11 21.8543 110.11 21.858H110.118C110.121 21.8616 110.121 21.8616 110.125 21.8616C110.126 21.863 110.128 21.8641 110.13 21.8647C110.132 21.8653 110.134 21.8655 110.136 21.8653C110.147 21.8727 110.159 21.8766 110.173 21.8763H110.176C110.18 21.88 110.18 21.88 110.183 21.88H110.187C110.191 21.8836 110.191 21.8836 110.194 21.8836H110.209L110.213 21.8873H110.216C110.223 21.8889 110.229 21.8901 110.235 21.891H110.246C110.256 21.894 110.268 21.8952 110.279 21.8946C110.282 21.8946 110.286 21.8983 110.293 21.8946H110.297V21.8983H110.301ZM128.871 15.6773L128.856 16.4796L112.279 20.3595C112.227 20.3542 112.173 20.3579 112.122 20.3705L110.883 20.6563H110.88V20.6526L110.957 16.4027H110.96L128.933 12.2261L128.871 15.6773ZM114.229 5.90613L127.688 11.3871L110.469 15.3842V15.3878H110.462L96.9996 9.90325L114.229 5.90613ZM95.7244 10.57L109.857 16.3294L109.784 20.5354V20.539L103.152 17.8352L101.239 17.0585L95.6475 14.7797L95.7244 10.5737M109.685 38.5865L95.6402 32.8675L95.6805 28.6505L109.762 34.3806L109.685 38.5865ZM109.78 33.1972V33.2009L95.6915 27.4708V27.4671L95.7354 23.2429L109.857 28.9912L109.78 33.1972ZM110.458 28.0497L96.9959 22.5687L100.481 21.7407V21.7701C100.48 21.8792 100.513 21.9859 100.573 22.0766C100.634 22.1673 100.72 22.2378 100.821 22.2793L113.364 27.3755L110.462 28.0497H110.458ZM128.757 34.5308L110.784 38.7038H110.781L110.843 35.3588L110.861 34.4539V34.4502L128.834 30.2772L128.757 34.5308ZM128.853 29.1451L110.88 33.3218H110.876V33.3181L110.938 30.0281L110.957 29.0645L115.13 28.0936H115.134L116.05 28.4673C116.141 28.5054 116.242 28.5169 116.339 28.5003C116.354 28.4997 116.369 28.4972 116.383 28.493L128.922 25.5877L128.853 29.1451ZM134.774 23.1036L116.823 27.2437L116.918 23.0414L134.855 18.8501L134.774 23.1036Z" fill="white"/>
                            <path d="M13.3207 28.9225C13.3207 31.3882 11.3288 32.1635 10.0907 32.1635C6.94931 32.1635 5.09081 30.8379 5.09081 27.741C5.08324 27.1239 5.16092 26.5087 5.32166 25.9128H0.240838C0.0776454 26.5685 -0.00322384 27.2419 9.83332e-05 27.9176C9.83332e-05 32.5185 3.23122 35.1717 9.73705 35.1717C13.4533 35.1717 18.3648 33.7216 18.3648 29.8648V25.9128H13.3207V28.9225ZM13.3207 21.6775V23.9347H18.3648V18.6692C18.3648 12.5193 14.4716 10.4405 9.55971 10.4405C6.72963 10.4259 3.93229 11.0459 1.37345 12.2548L2.61306 15.351C4.47401 14.4355 6.51228 13.9369 8.58575 13.8899C11.3735 13.8899 13.3192 14.7304 13.3192 17.8277V19.1118C7.91044 19.6405 3.16599 20.7836 1.09937 23.9347H6.50044C7.89028 22.6052 10.25 22.0523 13.3196 21.6775M23.3442 0H28.7427V23.9347H23.3442V0ZM23.3442 25.9128H28.7427V34.7299H23.3442V25.9128ZM37.4064 6.76763C39.0868 6.76763 40.3707 5.57326 40.3707 4.11326C40.3707 2.61114 39.0883 1.41383 37.4064 1.41383C35.7685 1.41383 34.4409 2.60967 34.4409 4.11326C34.4409 5.57362 35.7685 6.76763 37.4064 6.76763ZM34.4237 10.8835H39.8248V23.9347H34.4237V10.8835ZM34.4237 25.9128H39.8248V34.7299H34.4237V25.9128ZM49.4177 23.0514C49.4177 17.0777 51.1436 13.6254 55.3472 13.6254C56.497 13.6254 58.132 14.3948 58.132 16.7659V23.9351H63.3546V16.1186C63.3546 12.8945 59.7699 10.4398 55.6099 10.4398C47.9103 10.4398 44.0606 15.5708 44.0606 23.3137C44.0606 23.5233 44.0661 23.7292 44.072 23.934H49.4305C49.4205 23.6397 49.4159 23.3452 49.4166 23.0507M58.1327 29.002C58.1327 31.6597 56.3189 31.8073 55.0815 31.8073C51.8167 31.8073 50.0982 29.8198 49.5852 25.9117H44.246C45.0771 31.5751 48.6768 34.9519 53.6657 34.9519C55.7004 34.9519 57.2053 34.5984 58.1338 34.0668V35.5689C58.1338 38.7563 56.6289 40.9249 52.6466 40.9249C50.6584 40.9144 48.7014 40.4289 46.9389 39.5089L45.4365 43.0488C47.1613 44.0658 50.17 44.7304 53.5774 44.7304C59.5061 44.7304 63.3579 41.4569 63.3579 35.0856V25.9128H58.1338L58.1327 29.002ZM81.4764 25.9121H86.8735V34.7299H81.4775L81.4764 25.9121ZM77.4062 10.4416C70.2181 10.4416 68.1643 13.8921 68.1643 17.7408V23.9351H73.561V17.8284C73.561 15.8826 74.7526 13.8459 77.5891 13.8459C80.4255 13.8459 81.4775 15.8826 81.4775 17.8284V23.9344H86.8746V17.7397C86.8746 13.891 84.594 10.4405 77.4062 10.4405V10.4416ZM68.1643 25.9128H73.5606V34.7299H68.1643V25.9128Z" fill="white"/>
                        </svg>
                    )}
                    <span className={`hidden xl:inline text-sm transition-colors duration-300 ${
                        isScrolled ? 'text-gray-800' : 'text-white'
                    }`}>| US Services</span>
                                </div>

                {/* Tablet Utility Bar - Centered between logo and hamburger */}
                <div className="hidden md:block lg:hidden flex-1 flex justify-center">
                    <UtilityBar inline compact onSearchClick={() => setSearchModalOpen(true)} />
                            </div>

                {/* Desktop Nav Links */}
                <div className="nav-links hidden xl:block">
                    <ul className={`flex items-center gap-8 2xl:gap-10 transition-colors duration-300 ${
                        isScrolled ? 'text-gray-800' : 'text-white'
                    }`}>
                        {Object.entries(submenuConfigs).map(([key, config]) => (
                            <li
                                key={key}
                                className="cursor-pointer flex items-center gap-1 group"
                                onMouseEnter={() => { cancelClose(); setOpenKey(key); }}
                                onMouseLeave={scheduleClose}
                            >
                                <span>{config.label}</span>
                                <svg width="16" height="10" viewBox="0 0 16 10" fill="none" stroke="currentColor" strokeWidth="2" className="transition-transform duration-200 group-hover:rotate-180">
                                    <path d="M3 3L8 8L13 3"/>
                    </svg>
                                {openKey === key && (
                                    <Submenu data={config} onMouseEnter={cancelClose} onMouseLeave={scheduleClose} />
                                )}
                </li>
                        ))}
                        <li>
                            <button className={`font-bold border rounded-md cursor-pointer transition-all duration-300 ${
                                isScrolled 
                                    ? 'border-transparent text-black px-6 py-2' 
                                    : 'border-white text-white px-5 py-2'
                            }`} style={isScrolled ? {background: 'linear-gradient(88.89deg,#008ad4 10.61%,#00d1ff 64.08%)'} : {}}>Contact us</button>
                </li>
            </ul>
        </div>

                {/* Mobile/Tablet Hamburger */}
                <div className="block xl:hidden flex items-center gap-4">
                    {/* Mobile Search Icon Only */}
                    <svg 
                        width="20" 
                        height="20" 
                        viewBox="0 0 24 24" 
                        fill="none" 
                        xmlns="http://www.w3.org/2000/svg" 
                        className={`cursor-pointer ml-2 transition-colors duration-300 ${
                            isScrolled ? 'text-gray-800' : 'text-white'
                        }`}
                        onClick={() => setSearchModalOpen(true)}
                    >
                        <path d="M21.71 20.29L18 16.61A9 9 0 1016.61 18l3.68 3.68a1 1 0 001.42-1.42zM11 18a7 7 0 117-7 7 7 0 01-7 7z" fill="currentColor"/>
                    </svg>
                    <button aria-label="Open menu" onClick={() => { setMobileMenuOpen((v) => !v); }} className={`p-2 transition-colors duration-300 ${
                        isScrolled ? 'text-gray-800' : 'text-white'
                    }`}>
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z" />
                        </svg>
                    </button>
                </div>
            </div>

            {/* Mobile Overlay Menu */}
            {mobileMenuOpen && (
                <MobileOverlayMenu isOpen={mobileMenuOpen} onClose={() => setMobileMenuOpen(false)} />
            )}

            {/* Search Modal */}
            <SearchModal isOpen={searchModalOpen} onClose={() => setSearchModalOpen(false)} />
        </div>
    );
}